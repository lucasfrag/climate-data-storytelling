<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Estações Meteorológicas no Tempo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="./assets/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 70vh; }
    #timeline, #charts {
      background: rgba(255,255,255,0.95);
      padding: 10px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    #timeline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    #yearLabel { font-weight: bold; margin-left: 10px; }
    #controls { display: flex; gap: 10px; align-items: center; }
    select, button { padding: 5px 10px; font-size: 1em; }
    #charts { height: 30vh; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="timeline">
    <div id="controls">
      <label for="ufSelect">UF:</label>
      <select id="ufSelect">
        <option value="TODOS">Todos</option>
      </select>
      <button id="playBtn">▶️</button>
    </div>
    <div>
      <input type="range" id="yearSlider" min="1900" max="2025" value="2025" />
      <span id="yearLabel">2025</span>
    </div>
  </div>
  <div id="charts">
    <canvas id="graficoEstacoes"></canvas>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-30.05, -51.17], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marcadores = [];
    let estacoes = [];
    let intervalo = null;
    let chart;

    async function carregarEstacoes() {
      const resp = await fetch('./dataset/estacoes.json');
      estacoes = await resp.json();
      preencherUFs(estacoes);
      atualizarMapa(parseInt(document.getElementById('yearSlider').value));
      desenharGrafico();
    }

    function normalizarData(data) {
      if (data.includes('/')) {
        const [dia, mes, ano] = data.split('/');
        return `${ano.length === 2 ? '20' + ano : ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
      }
      return data;
    }

    function formatarDataParaBR(dataISO) {
      const [ano, mes, dia] = dataISO.split('-');
      return `${dia}/${mes}/${ano}`;
    }

    function preencherUFs(estacoes) {
      const select = document.getElementById('ufSelect');
      const ufs = Array.from(new Set(estacoes.map(e => e.uf))).sort();
      for (const uf of ufs) {
        const opt = document.createElement('option');
        opt.value = uf;
        opt.textContent = uf;
        select.appendChild(opt);
      }
    }

    function atualizarMapa(ano) {
      const ufSelecionado = document.getElementById('ufSelect').value;
      marcadores.forEach(m => map.removeLayer(m));
      marcadores = [];

      estacoes
        .map(est => ({ ...est, data_fundacao: normalizarData(est.data_fundacao) }))
        .filter(est => parseInt(est.data_fundacao.substring(0, 4)) <= ano)
        .filter(est => ufSelecionado === 'TODOS' || est.uf === ufSelecionado)
        .forEach(est => {
          const dataBR = formatarDataParaBR(est.data_fundacao);
          const marker = L.marker([est.latitude, est.longitude])
            .bindPopup(`<strong>${est.estacao}</strong><br>UF: ${est.uf}<br>Inaugurada em ${dataBR}`)
            .addTo(map);
          marcadores.push(marker);
        });
    }

    function desenharGrafico() {
      const anos = {};
      estacoes.forEach(est => {
        const ano = parseInt(normalizarData(est.data_fundacao).substring(0, 4));
        anos[ano] = (anos[ano] || 0) + 1;
      });
      const labels = Object.keys(anos).sort((a, b) => a - b);
      const dados = labels.map(ano => anos[ano]);

      const ctx = document.getElementById('graficoEstacoes').getContext('2d');
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Estações por Ano de Fundação',
            data: dados,
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { title: { display: true, text: 'Ano' } },
            y: { title: { display: true, text: 'Número de Estações' }, beginAtZero: true }
          }
        }
      });
    }

    const slider = document.getElementById('yearSlider');
    const label = document.getElementById('yearLabel');
    const btn = document.getElementById('playBtn');

    slider.addEventListener('input', () => {
      const ano = parseInt(slider.value);
      label.textContent = ano;
      atualizarMapa(ano);
    });

    document.getElementById('ufSelect').addEventListener('change', () => {
      atualizarMapa(parseInt(slider.value));
    });

    btn.addEventListener('click', () => {
      if (intervalo) {
        clearInterval(intervalo);
        intervalo = null;
        btn.textContent = '▶️';
      } else {
        intervalo = setInterval(() => {
          let ano = parseInt(slider.value);
          if (ano < 2025) {
            ano++;
            slider.value = ano;
            label.textContent = ano;
            atualizarMapa(ano);
          } else {
            clearInterval(intervalo);
            intervalo = null;
            btn.textContent = '▶️';
          }
        }, 500);
        btn.textContent = '⏸️';
      }
    });

    carregarEstacoes();
  </script>
</body>
</html>